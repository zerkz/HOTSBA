<!DOCTYPE html>
<html>
  <head>
    <script>
    window.nodeRequire = require;
    delete window.require;
    delete window.exports;
    delete window.module;
    </script>
    <script src="./ui/js/jquery-3.1.0.min.js"></script>
    <script src="./ui/js/materialize.min.js"></script>
    <script src="http://twitter.github.com/hogan.js/builds/3.0.1/hogan-3.0.1.js"></script>
    <script src="./ui/templates/heroes_table.js"> </script>
    <link href="./ui/css/materialize.min.css" rel="stylesheet" type="text/css"/>
    <title>Hots MPH</title>
  </head>
  <body>
    <script>
    let PlayerModel = nodeRequire(process.cwd() + '/models/player.js');
    let HeroImages = nodeRequire(process.cwd() + '/models/hero_images.js');
    let heroesImageMap;
    Materialize.toast('Checking for new heroes..', 4000)
    HeroImages.checkIfHeroesNeedDownloaded()
      .spread(function (message, updatedHeroesJSON) {
        heroesImageMap = updatedHeroesJSON;
        Materialize.toast(message, 4000, 'rounded');
      }).catch(function (error) {
        Materialize.toast(error + ". Please restart the HotsMPH",8000,'rounded', function () {
          console.log('quit callback');
        });
      });

      function clearAllHeroCollections() {
        console.log('clicky');
        $('.heroes-collection').replaceWith($('<div class="heroes-container"></div>'));
        $('.player-text-input').val('');
      }

    function upsertHeroesTable(name, element) {
      if (!name) {
        return;
      }
      PlayerModel.getTopPlayedHeroesByPlayerNameOrBattleTag(name, 5)
        .then(function (topHeroes) {
          topHeroes = topHeroes.map(function (topHero) {
            let filteredHero = heroesImageMap.filter(hero => hero.PrimaryName == topHero.name);
            if (!filteredHero.length) {
              throw "PrimaryName in HeroesJSON didn't map to scrapped hero name";
            } else {
              topHero.imageName = filteredHero[0].ImageURL;
              return topHero;
            }
          });
          let heroesTable = templates['heroes_table'].render({
            "heroes" : topHeroes
          });
          $(element).replaceWith($(heroesTable));
      });
    }
    </script>
    <div id="masterDiv" class="container">
      <div class="row">
        <div class="col s6">
            <a class="waves-effect waves-light btn" id="clearButton">Clear All</a>
        </div>
      </div>
      <div class="row">
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
      </div>
      <div class="row">
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
        <div class="player-heroes-section section col s4">
          <h5>Player:</h5>
          <input type="text" class="player-text-input"
            onblur="upsertHeroesTable(this.value,this.parentNode.querySelectorAll('.heroes-container'))" />
          <div class="heroes-container"></div>
        </div>
      </div>
    </div>
    <script>
    $('#clearButton').click(clearAllHeroCollections);
    </script>
  </body>
</html>
